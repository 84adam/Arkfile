<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArkFile - Shared File</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .hidden { display: none; }
        .file-info {
            margin-bottom: 20px;
        }
        .password-form {
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #007bff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .progress-bar-fill {
            height: 10px;
            background-color: #4CAF50;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .file-icon {
            font-size: 48px;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ArkFile</h1>
            <nav>
                <a href="/">Home</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2>Shared File</h2>
            <div class="file-info">
                <div class="file-icon">ðŸ“„</div>
                <h3 id="fileName">Loading...</h3>
                <p id="fileDetails"></p>
                <p id="passwordHint" class="hidden"></p>
            </div>

            <div id="passwordForm" class="password-form hidden">
                <h4>This file is password protected</h4>
                <p>Enter the password provided by the file owner to access this file.</p>
                <form id="sharePasswordForm">
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Enter file password" required>
                    </div>
                    <button type="submit" class="btn primary">Verify Password</button>
                </form>
            </div>

            <div id="extraPasswordForm" class="password-form hidden">
                <h4>Share Link Password Required</h4>
                <p>This share link requires an additional password.</p>
                <form id="shareAccessForm">
                    <div class="form-group">
                        <label for="accessPassword">Access Password:</label>
                        <input type="password" id="accessPassword" placeholder="Enter share access password" required>
                    </div>
                    <button type="submit" class="btn primary">Access File</button>
                </form>
            </div>

            <div id="downloadSection" class="hidden">
                <div class="progress-container hidden">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                    <p id="progressText">0%</p>
                </div>
                <button id="downloadBtn" class="btn primary">Download File</button>
            </div>

            <div id="statusMessage" class="hidden"></div>
        </div>
    </main>

    <!-- WebAssembly loader -->
    <script src="/wasm_exec.js"></script>
    
    <!-- Compiled TypeScript application -->
    <script src="/js/dist/app.js"></script>

    <script>
        // Parse share ID from URL path
        const pathSegments = window.location.pathname.split('/');
        const shareId = pathSegments[pathSegments.length - 1];
        
        // DOM ready handler
        document.addEventListener('DOMContentLoaded', async () => {
            if (!shareId) {
                showError('Invalid share link');
                return;
            }
            
            // Initialize share access UI using the TypeScript module
            try {
                // Wait for modules to load
                const { ShareAccessUI } = await import('/js/dist/shares/share-access.js');
                
                // Replace the existing content with the proper share access interface
                const mainContainer = document.querySelector('main .container .card');
                if (mainContainer) {
                    mainContainer.innerHTML = '<div id="share-access-container"></div>';
                    
                    // Initialize the ShareAccessUI
                    const shareAccessUI = new ShareAccessUI('share-access-container', shareId);
                    await shareAccessUI.initialize();
                }
                
            } catch (error) {
                console.error('Error initializing share access:', error);
                showError('Failed to initialize share access interface. Please refresh the page.');
            }
        });
        
        // Simple error display function (fallback)
        function showError(message) {
            const fileNameEl = document.getElementById('fileName');
            const fileDetailsEl = document.getElementById('fileDetails');
            
            if (fileNameEl) fileNameEl.textContent = 'Error';
            if (fileDetailsEl) fileDetailsEl.innerHTML = `<p style="color: #e74c3c;">${message}</p>`;
            
            // Hide all forms
            const forms = ['passwordForm', 'extraPasswordForm', 'downloadSection'];
            forms.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }
    </script>
